---
import { render } from 'astro:content'

import Categorizer from '~/components/base/Categorizer.astro'
import ListItem from '~/components/views/ListItem.astro'
import Toc from '~/components/toc/Toc.astro'
import Warning from '~/components/base/Warning.astro'

import { FEATURES } from '~/config'
import { isSameYear, getYear } from '~/utils/datetime'
import { getFilteredPosts, getSortedPosts } from '~/utils/data'

import type { CollectionEntry, CollectionKey } from 'astro:content'

interface Props {
  collectionType: CollectionKey
  pageToc: boolean
}

const { collectionType, pageToc } = Astro.props

const VALID_COLLECTION_TYPE = ['blog', 'changelog', 'streams', 'feeds']
const WARNING = `The '${collectionType}' collection type is not built-in.
  Modify <code>ListView.astro</code> to render it.`

/* Toc */
const { toc } = FEATURES
const tocEnabled = Array.isArray(toc) && toc[0] && pageToc
let years: string[] = []

/* Posts */
let sortedBlogItems: CollectionEntry<'blog'>[] = []
if (collectionType === 'blog') {
  const blogItems = await getFilteredPosts(collectionType)
  sortedBlogItems = getSortedPosts(blogItems)

  if (tocEnabled) {
    const yearsSet = new Set<number>()
    sortedBlogItems.forEach((item) => {
      const year = getYear(item.data.pubDate)
      yearsSet.add(year)
    })

    years = Array.from(yearsSet)
      .sort((a, b) => b - a)
      .map((year) => year.toString())
  }
}
---

{tocEnabled && <Toc anchors={years} />}

{
  collectionType === 'blog' && (
    <div aria-label="Post list">
      {sortedBlogItems.length === 0 ? (
        <div class="py-2 op-50">nothing here yet</div>
      ) : (
        sortedBlogItems.map(async (item, idx) => {
          const { data, id } = item
          const { remarkPluginFrontmatter } = await render(item)
          const minutesRead =
            data.minutesRead || remarkPluginFrontmatter.minutesRead

          return (
            <>
              {!isSameYear(
                data.pubDate,
                sortedBlogItems[idx - 1]?.data.pubDate
              ) && (
                <Categorizer
                  {idx}
                  needId={tocEnabled}
                  text={getYear(data.pubDate).toString()}
                />
              )}
              <ListItem
                {idx}
                {collectionType}
                redirect={data.redirect}
                postSlug={id}
                title={data.title}
                video={data.video}
                radio={data.radio}
                date={data.pubDate}
                {minutesRead}
                platform={data.platform}
              />
            </>
          )
        })
      )}
    </div>
  )
}

{!VALID_COLLECTION_TYPE.includes(collectionType) && <Warning html={WARNING} />}
